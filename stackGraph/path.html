<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery
/jquery-1.4.min.js"></script>
	<style type="text/css">
	body, html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"Î¢ÈíÑÅºÚ";}
	</style>
</head>
<body>
	<div id="output"></div>
	<svg id = "svg1" width = "1000" height="500"></svg>;
	<button>Update</button>
</body>
</html>
<script type="text/javascript">
function bumpLayer(n) {

  function bump(a) {
    var x = 1 / (.1 + Math.random()),
        y = 2 * Math.random() - .5,
        z = 10 / (.1 + Math.random());
    for (var i = 0; i < n; i++) {
      var w = (i / n - y) * z;
      a[i] += x * Math.exp(-w * w);
    }
  }
	//alert("1");
  var a = [], i;
  for (i = 0; i < n; ++i) a[i] = 0;
  //for (i = 0; i < 5; ++i) bump(a);
  return a.map(function(d, i) { return {x: i * (800 / n), y: Math.random() * 50 + 1}; });
}
//alert("!");
var n = 8;
var m = 20;
var layer = [];
for (var i=0;i<n;i++) layer[i] = bumpLayer(m);
//alert(layer[0][0].y.toString());
makeStackGraph(layer);
function makeStackGraph(data)
{
	var g0 = [];
	for (var i=0;i<data[0].length;i++)
	{
		//alert("2");
		g0[i] = {x:0,y:0};
		//alert(g0[i].x.toString());
		var tmp = 0;
		for (var j=0;j<data.length;j++)
			tmp += data[j][i].y;
		tmp = tmp / data.length;
		g0[i].x = data[0][i].x;
		g0[i].y = (0-tmp) / 2;
		//g0[i].y=0;
	}
	//alert(g0[0].y.toString());
	var len = data[0].length;
	Y = new Array(len);
	height = document.getElementById("svg1").getAttribute("height") - 100;
	for (var i=0;i<len;i++) Y[i] = height-g0[i].y;
	//alert(Y[0].toString());
	for (var i=0;i<data.length;i++) 
		for (var j=0;j<data[i].length;j++) Y[j]-=data[i][j].y;
	//alert(Y[0].toString());
	for (var i=0;i<data.length;i++){
		if (i % 2 == 0) makeShape("#556",data[i]);
		else makeShape("#aad",data[i]);
		//alert("s");
	}
	//alert(Y[0].toString());
	//for (var i=0;i<100;i++) Y[i] = height;
	makeShape("white",g0);
	function makeShape(color,data)
	{
	var x = [];
	var y = [];
	var n = data.length;
	//alert(n.toString());
	
	for (var i=0;i<n;i++){
		x[i] = data[i].x;
		y[i] = Y[i];
		Y[i] = Y[i] + data[i].y;
		//alert(Y[i].toString());
		//alert(y[i].toString());
		//y[i] = Y[i];
	//	document.getElementById("output").innerHTML+="<br>" + x[i] + " " + y[i] + "</br>";
	}
	
	var h = [];
	var u = [];
	var lam = [];
	for (var i=0;i<n-1;i++){
		h[i] = x[i+1] - x[i];
	}
	u[0] = 0;
	lam[0] = 1;
	for (var i=1;i<n-1;i++){
		u[i] = h[i-1] / (h[i] + h[i-1]);
		lam[i] = h[i] / (h[i] + h[i-1]);
	}
	var a = [];
	var b = []
	var c = [];
	var m = [];
	for (var i=0;i<n;i++){
		m[i] = [];
	}
	for (var i=0;i<n;i++){
		for (var j=0;j<n;j++){
			m[i][j] = 0;
		}
		if (i==0)
		{
			m[i][0] = 2;
			m[i][1] = 1;
			
			b[0] = 2;
			c[0] = 1;
		}
		else if (i==(n-1))
		{
			m[i][n-2] = 1;
			m[i][n-1] = 2;
			
			a[n-1] = 1;
			b[n-1] = 2;
		}
		else
		{
			m[i][i-1] = lam[i];
			m[i][i] = 2;
			m[i][i+1] = u[i];
			
			a[i] = lam[i];
			b[i] = 2;
			c[i] = u[i];
		}
	}
	//alert("2");
	var g = [];
	g[0] = 3 * (y[1] - y[0]) / h[0];
	g[n-1] = 3 * (y[n-1] - y[n-2])/ h[n-2];
	for (var i=1;i<n-1;i++)
	{
		 g[i] = 3 * ((lam[i] * (y[i] - y[i-1])/h[i-1]) + u[i] * (y[i+1] - y[i])/h[i]);
	}
	
	var p = [];
	var q = [];
	p[0] = b[0];
    for (var i=0;i<n-1;i++)
    {
        q[i] = c[i]/p[i];
    }
    for (var i=1;i<n;i++)
    {
        p[i] = b[i] - a[i] * q[i-1];
    }
    //alert("3");
    var su = [];
    var sq = [];
    var sx = [];
    su[0] = c[0]/b[0];
    sq[0] = g[0]/b[0];
    for (var i = 1; i < n - 1; i++)
    {
        su[i] = c[i]/(b[i] - su[i-1]*a[i]);
    }
    
    for (var i = 1; i < n; i++)
    {
        sq[i] = (g[i] - sq[i-1]*a[i])/(b[i] - su[i-1]*a[i]);
    }

    sx[n-1] = sq[n-1];
    for (var i = n - 2; i >= 0; i--)
    {
        sx[i] = sq[i] - su[i]*sx[i+1];
    }
	var ph = h;
	var px = x;
	var psx = sx;
	var py = y;
	//alert("3");
	function func(k,vX,ph,px,psx,py)
	{
		//alert("func!");
		var p1 = (ph[k] + 2.0 * (vX - px[k])) * ((vX - px[k+1]) * (vX - px[k+1])) * py[k] / (ph[k] *ph[k] * ph[k]);
		var p2 = (ph[k] - 2.0 * (vX - px[k+1])) * Math.pow((vX - px[k]), 2.0) * py[k+1] / Math.pow(ph[k], 3.0);
		var p3 =  (vX - px[k]) * Math.pow((vX - px[k+1]), 2.0) * psx[k] / Math.pow(ph[k], 2.0);
        var p4 =  (vX - px[k+1]) * Math.pow((vX - px[k]), 2.0) * psx[k+1] / Math.pow(ph[k], 2.0);
        return p1 + p2 + p3 + p4;
	}
	//alert("4");
	
	var name = "M" + x[0].toString() + ",500 ";
	makeShape.yList = [];
	for (var i=0;i<n;i++){
		if (i==0)
		{
			tmp = "L";
			tmp = tmp + x[i].toString() + "," + Math.ceil(y[i]).toString() + " ";
			name = name.concat(tmp);
			//alert(name);
		}
		else 
		{
			var delta = 0.3;
			for (var pointX = x[i-1];Math.abs(pointX - x[i]) > 0.00001;pointX +=delta)
			{
				var pointY = func(i-1,pointX,ph,px,psx,py);
				var tmp = Math.floor(pointX * 10);
				if (makeShape.yList[tmp.toString()]) pointY = Math.min(pointY,makeShape.yList[tmp.toString()]);
				makeShape.yList[tmp.toString()] = pointY;
				//pointY = Math.max(pointY,yList[pointX]);
				//yList[pointX];
				tmp = "L";
				tmp = tmp + pointX.toString() + "," + Math.ceil(pointY).toString() + " ";
				name = name + tmp;
			//	alert(name);
			}
		}
	}
	name+="L" + x[n-1].toString() + ",500";
	var svg = document.getElementById("svg1");
	//document.getElementById("output").innerHTML+=name;
	var shape = document.createElementNS("http://www.w3.org/2000/svg", "path");
	shape.setAttributeNS(null, "d", name);
	//shape.setAttributeNS(null,"d","M0,200 L0,200 L800,200");
    shape.setAttributeNS(null, "fill", color);
    shape.setAttributeNS(null, "stroke", "white");
	shape.setAttributeNS(null, "stroke-width", 0.2);
	if (color != "white") shape.setAttributeNS(null,"fill-opacity",0.8);
	else shape.setAttributeNS(null,"fill-opacity",1);
	svg.appendChild(shape);
	}
}
</script>















